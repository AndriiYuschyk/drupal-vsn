<?php

/**
 * @file
 * Ukraine Air Alerts module with translation support.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function ukraine_air_alerts_help($route_name, RouteMatchInterface $route_match) {
    switch ($route_name) {
        case 'help.page.ukraine_air_alerts':
            return '<p>' . t('Цей модуль відображає сповіщення про повітряну тривогу в режимі реального часу для регіонів України на інтерактивній карті.') . '</p>';
    }
}

/**
 * Implements hook_theme().
 */
function ukraine_air_alerts_theme($existing, $type, $theme, $path) {
    return [
        'ukraine_air_alerts_map' => [
            'variables' => [
                'compact_mode' => FALSE,
                'show_legend' => TRUE,
                'show_status' => TRUE,
                'refresh_interval' => 60000,
            ],
            'template' => 'ukraine-air-alerts-map',
        ],
    ];
}

/**
 * Implements hook_page_attachments().
 */
function ukraine_air_alerts_page_attachments(array &$attachments) {
    $attachments['#attached']['drupalSettings']['ukraineAirAlerts'] = [
        'apiUrl' => '/ukraine-alerts/api',
        'refreshInterval' => 60000,
        'translations' => [
            'title' => t('Air Raid Alerts in Ukraine'),
            'lastUpdated' => t('Last updated:'),
            'loading' => t('Loading...'),
            'noAlert' => t('No Alert'),
            'partialAlert' => t('Partial Alert'),
            'fullAlert' => t('Full Alert'),
            'connected' => t('Connected'),
            'connectionError' => t('Connection Error'),
            'nextUpdate' => t('Next update in:'),
        ],
    ];
}

/**
 * Implements hook_library_info_build().
 */
function ukraine_air_alerts_library_info_build() {
    $libraries = [];

    $libraries['ukraine_air_alerts'] = [
        'js' => [
            'js/ukraine-air-alerts.js' => [
                'attributes' => [
                    'defer' => TRUE,
                ],
            ],
        ],
        'css' => [
            'theme' => [
                'css/ukraine-air-alerts.css' => [
                    'media' => 'all',
                ],
            ],
        ],
        'dependencies' => [
            'core/jquery',
            'core/drupal',
            'core/drupalSettings',
            'core/once',
        ],
    ];

    return $libraries;
}

/**
 * Preprocess function for ukraine_air_alerts_map theme.
 */
function template_preprocess_ukraine_air_alerts_map(&$variables) {
    // Додаємо переклади до змінних шаблону
    $variables['translations'] = [
        'title' => t('Air Raid Alerts in Ukraine'),
        'lastUpdated' => t('Last updated:'),
        'loading' => t('Loading...'),
        'noAlert' => t('No Alert'),
        'partialAlert' => t('Partial Alert'),
        'fullAlert' => t('Full Alert'),
        'connected' => t('Connected'),
        'nextUpdate' => t('Next update in:'),
    ];
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function ukraine_air_alerts_form_language_admin_overview_form_alter(&$form, FormStateInterface $form_state, $form_id) {
    // Додаємо інформацію про модуль до форми управління мовами
    if (isset($form['languages'])) {
        $form['#attached']['library'][] = 'ukraine_air_alerts/ukraine_air_alerts';
    }
}

/**
 * Implements hook_locale_translation_projects_alter().
 */
function ukraine_air_alerts_locale_translation_projects_alter(&$projects) {
    $projects['ukraine_air_alerts'] = [
        'name' => 'Ukraine Air Alerts',
        'info' => [
            'name' => 'Ukraine Air Alerts',
            'interface translation server pattern' => 'translations/%language.po',
        ],
    ];
}